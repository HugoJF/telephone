<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Telephone</title>
  </head>
  <body>
    <script type="text/javascript">
      var audioContext = new AudioContext();

      var worker = new Worker('worker.js');

      var nextPlay = [];
      function playAudioSamples(id, samples, sampleRate) {
        //console.log(sampleRate);
        var audioBuffer = audioContext.createBuffer(1, samples.length, sampleRate);
        audioBuffer.copyToChannel(samples, 0);

        var audioSource = audioContext.createBufferSource();
        audioSource.buffer = audioBuffer;

        audioSource.connect(audioContext.destination);

        if (!nextPlay[id] || nextPlay[id] < audioContext.currentTime) {
          //console.log('Start out of sync! ' + id);
          nextPlay[id] = audioContext.currentTime;
        }

        audioSource.start(nextPlay[id]);
        nextPlay[id] += audioBuffer.duration;
      }

      worker.onmessage = function(e) {
        switch (e.data.type) {
          case 'audio-data':
            playAudioSamples(e.data.id, e.data.samples, e.data.sampleRate);
            break;
          default:
            console.log(e.data);
            break;
        }
      };

      worker.postMessage("ws://192.168.0.2:9000");
    </script>
  </body>
</html>
