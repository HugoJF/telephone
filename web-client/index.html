<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Telephone</title>
  </head>
  <body>
    <script type="text/javascript">
      var Module = {};
    </script>
    <script src="silk.js"></script>
    <script src="worker.js"></script>
    <script type="text/javascript">
      var audioContext = new AudioContext();

      var nextPlay = [];
      function playAudioSamples(id, samples, sampleRate) {
        //console.log(sampleRate);
        var audioBuffer = audioContext.createBuffer(1, samples.length, sampleRate);

        var audioData = audioBuffer.getChannelData(0);
        for (var i = 0; i < samples.length; i++) {
          audioData[i] = samples[i] / 0xFFFF;
        }

        var audioSource = audioContext.createBufferSource();
        audioSource.buffer = audioBuffer;

        audioSource.connect(audioContext.destination);

        if (!nextPlay[id] || nextPlay[id] < audioContext.currentTime) nextPlay[id] = audioContext.currentTime;
        audioSource.start(nextPlay[id]);
        nextPlay[id] += audioBuffer.duration;
      }

      function postMessage(data) {
        switch (data.type) {
          case 'audio-data':
            playAudioSamples(data.id, data.samples, data.sampleRate);
            break;
          default:
            console.log(data);
            break;
        }
      };

      onmessage("ws://192.168.0.2:9000");
    </script>
  </body>
</html>
